name: Deploy to Raspberry Pi

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    # Matching your Pi's exact labels: 'self-hosted', 'Linux', 'ARM'
    runs-on: [self-hosted, Linux, ARM] 

    steps:
      - name: Update Code on Raspberry Pi
        run: |
          cd /opt/opensoak
          git fetch --all
          git reset --hard origin/main

      - name: Install Frontend Dependencies
        run: |
          cd /opt/opensoak/frontend
          /home/mcglothi/.nvm/versions/node/v20.20.0/bin/npm install

      - name: Restart OpenSoak Services
        run: |
          # Restarting both services to apply code changes
          sudo systemctl restart opensoak.service || echo "Backend service restart failed."
          sudo systemctl restart opensoak-frontend.service || echo "Frontend service restart failed."
          echo "OpenSoak deployment complete."
